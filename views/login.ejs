<% 
const body = `
<!-- Login/Signup Page -->
<section class="auth-page">
    <div class="container">
        <!-- reCAPTCHA container (required by Firebase) -->
        <div id="recaptcha-container" style="display: none;"></div>
        
        <div class="auth-container">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">Login</button>
                <button class="auth-tab" onclick="switchTab('signup')">Sign Up</button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form-container">
                <h2>Welcome Back!</h2>
                <p class="auth-subtitle">Sign in to access your MasterHosting account</p>
                
                <form id="emailLoginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">
                            <i class="fas fa-envelope"></i> Email
                        </label>
                        <input 
                            type="email" 
                            id="loginEmail" 
                            placeholder="Enter your email" 
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">
                            <i class="fas fa-lock"></i> Password
                        </label>
                        <input 
                            type="password" 
                            id="loginPassword" 
                            placeholder="Enter your password" 
                            required
                        >
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
                
                <div id="loginMessage" class="auth-message"></div>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" class="auth-form-container" style="display: none;">
                <h2>Create Account</h2>
                <p class="auth-subtitle">Join MasterHosting and get free website hosting!</p>
                
                <form id="emailSignupForm" class="auth-form">
                    <div class="form-group">
                        <label for="signupName">
                            <i class="fas fa-user"></i> Full Name
                        </label>
                        <input 
                            type="text" 
                            id="signupName" 
                            placeholder="Enter your full name" 
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail">
                            <i class="fas fa-envelope"></i> Email
                        </label>
                        <input 
                            type="email" 
                            id="signupEmail" 
                            placeholder="Enter your email" 
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPassword">
                            <i class="fas fa-lock"></i> Password
                        </label>
                        <input 
                            type="password" 
                            id="signupPassword" 
                            placeholder="Create a password (min 6 characters)" 
                            required
                            minlength="6"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPasswordConfirm">
                            <i class="fas fa-lock"></i> Confirm Password
                        </label>
                        <input 
                            type="password" 
                            id="signupPasswordConfirm" 
                            placeholder="Confirm your password" 
                            required
                            minlength="6"
                        >
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
                
                <div id="signupMessage" class="auth-message"></div>
            </div>
        </div>
    </div>
</section>

<script type="module">
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, RecaptchaVerifier } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

// Wait for Firebase to be ready
function waitForAuth() {
    return new Promise((resolve) => {
        const check = () => {
            if (window.firebaseAuth) {
                resolve(window.firebaseAuth);
            } else {
                setTimeout(check, 100);
            }
        };
        check();
    });
}

const auth = await waitForAuth();
console.log('üî• Firebase Auth ready for login page');

// Switch between login and signup tabs
window.switchTab = function(tab) {
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const tabs = document.querySelectorAll('.auth-tab');
    
    tabs.forEach(t => t.classList.remove('active'));
    
    if (tab === 'login') {
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
        tabs[0].classList.add('active');
    } else {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
        tabs[1].classList.add('active');
    }
};

// Email/Password Login
let isLoggingIn = false;
document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Prevent multiple submissions
    if (isLoggingIn) {
        console.log('‚ö†Ô∏è Login already in progress, ignoring...');
        return;
    }
    
    isLoggingIn = true;
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const messageEl = document.getElementById('loginMessage');
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
    
    try {
        console.log('üîê Attempting login for:', email);
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log('‚úÖ Login successful:', userCredential.user.uid);
        
        messageEl.innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i> Login successful! Redirecting...</div>';
        
        setTimeout(() => {
            window.location.href = '/';
        }, 1500);
    } catch (error) {
        isLoggingIn = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        console.error('‚ùå Login error:', error.code, error.message);
        console.error('Full error:', JSON.stringify(error, null, 2));
        
        let errorMessage = 'Failed to login. Please try again.';
        
        if (error.code === 'auth/user-not-found') {
            errorMessage = 'No account found with this email.';
        } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'Incorrect password.';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email address.';
        } else if (error.code === 'auth/invalid-credential') {
            errorMessage = 'Invalid email or password.';
        } else if (error.code === 'auth/too-many-requests') {
            errorMessage = 'Too many failed attempts. Please try again later.';
        }
        
        messageEl.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i> ${errorMessage}<br><small>Error code: ${error.code}</small></div>`;
        
        // Send error to server for logging
        fetch('/api/log-error', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'login',
                error: error.code,
                message: error.message,
                email: email
            })
        }).catch(e => console.error('Failed to log error:', e));
    }
});

// Email/Password Signup
let isSigningUp = false;
document.getElementById('emailSignupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Prevent multiple submissions
    if (isSigningUp) {
        console.log('‚ö†Ô∏è Signup already in progress, ignoring...');
        return;
    }
    
    isSigningUp = true;
    
    const name = document.getElementById('signupName').value;
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
    const messageEl = document.getElementById('signupMessage');
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    // Validate passwords match
    if (password !== passwordConfirm) {
        messageEl.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i> Passwords do not match!</div>';
        isSigningUp = false;
        return;
    }
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
    
    try {
        console.log('üìù Attempting signup for:', email);
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        console.log('‚úÖ Account created:', userCredential.user.uid);
        
        // Update profile with name
        await updateProfile(userCredential.user, {
            displayName: name
        });
        console.log('‚úÖ Profile updated with name:', name);
        
        messageEl.innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i> Account created! Redirecting...</div>';
        
        setTimeout(() => {
            window.location.href = '/';
        }, 1500);
    } catch (error) {
        isSigningUp = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
        console.error('‚ùå Signup error:', error.code, error.message);
        console.error('Full error:', JSON.stringify(error, null, 2));
        
        let errorMessage = 'Failed to create account. Please try again.';
        
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'An account with this email already exists.';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = 'Password is too weak. Use at least 6 characters.';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email address.';
        } else if (error.code === 'auth/operation-not-allowed') {
            errorMessage = 'Email/Password sign-up is not enabled. Please contact support.';
        }
        
        messageEl.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i> ${errorMessage}<br><small>Error code: ${error.code}</small></div>`;
        
        // Send error to server for logging
        fetch('/api/log-error', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'signup',
                error: error.code,
                message: error.message,
                email: email
            })
        }).catch(e => console.error('Failed to log error:', e));
    }
});

// Redirect if already logged in
if (auth.currentUser) {
    window.location.href = '/';
}
</` + `script>
`;
%>
<%- include('layout', { title: 'Login - MasterHosting', page: 'login', body }) %>
